# CORRECTED Caddy configuration for terensys.fr
# This fixes both the redirect loop and SSL issues

# Handle non-www to www redirect
terensys.fr {
    redir https://www.terensys.fr{uri} permanent
}

# Handle HTTP to HTTPS redirect for www
http://www.terensys.fr {
    redir https://www.terensys.fr{uri} permanent
}

# Main site configuration
www.terensys.fr {
    # Enable automatic HTTPS with Let's Encrypt
    tls {
        protocols tls1.2 tls1.3
    }
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Serve files or proxy to backend
    # Option 1: Serve static files
    root * /var/www/html
    file_server
    
    # Option 2: Proxy to backend (uncomment if using Apache backend)
    # reverse_proxy localhost:8080
    
    # Optional: Error handling
    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        rewrite @404 /404.html
        file_server
    }
}

# Alternative single-block configuration (if you prefer):
# terensys.fr, www.terensys.fr {
#     @nonwww host terensys.fr
#     redir @nonwww https://www.terensys.fr{uri} permanent
#     
#     tls {
#         protocols tls1.2 tls1.3
#     }
#     
#     header {
#         Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#         X-Content-Type-Options "nosniff"
#         X-Frame-Options "SAMEORIGIN"
#     }
#     
#     root * /var/www/html
#     file_server
# }